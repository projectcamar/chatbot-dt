<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>UNVR DT AIMasterdata</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #123062;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #0066CB;
            color: white;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,102,203,0.2);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-container {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 500px;
            background: #fafafa;
            padding-bottom: 100px; /* Space for floating input */
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .user-message {
            background: #0066CB;
            color: white;
            margin-left: auto;
            text-align: right;
            max-width: 60%;
            width: fit-content;
            min-width: 60px;
        }

        .ai-message {
            background: #f1f3f4;
            color: #123062;
            border: 1px solid #e9ecef;
            max-width: 85%;
            width: fit-content;
            min-width: 60px;
        }

        .ai-message p {
            margin: 0 0 8px 0;
            line-height: 1.5;
        }

        .ai-message p:last-child {
            margin-bottom: 0;
        }

        .ai-message ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .ai-message li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .ai-message strong {
            color: #0066CB;
            font-weight: 600;
        }

        .ai-message h3 {
            color: #0066CB;
            font-weight: 600;
            font-size: 1.1em;
            margin: 12px 0 8px 0;
        }

        .ai-message h4 {
            color: #0066CB;
            font-weight: 600;
            font-size: 1em;
            margin: 10px 0 6px 0;
        }

        .ai-message {
            position: relative;
        }

        .ai-message .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #0066CB;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .ai-message:hover .copy-button {
            opacity: 1;
        }

        .ai-message .copy-button:hover {
            background: #0052a3;
        }

        .ai-message .copy-button.copied {
            background: #28a745;
        }

        .ai-message .pdf-button {
            position: absolute;
            top: 8px;
            right: 60px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .ai-message:hover .pdf-button {
            opacity: 1;
        }

        .ai-message .pdf-button:hover {
            background: #c82333;
        }

        .ai-message .pdf-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Table formatting styles */
        .ai-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.9em;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ai-message th {
            background: #0066CB;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #0052a3;
        }

        .ai-message td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .ai-message tr:nth-child(even) {
            background: #f8f9fa;
        }

        .ai-message tr:hover {
            background: #e3f2fd;
        }

        .ai-message tr:last-child td {
            border-bottom: none;
        }

        /* Mobile table responsiveness */
        @media screen and (max-width: 768px) {
            .ai-message table {
                font-size: 0.8em;
            }
            
            .ai-message th,
            .ai-message td {
                padding: 8px 6px;
            }
        }

        @media screen and (max-width: 480px) {
            .ai-message table {
                font-size: 0.75em;
            }
            
            .ai-message th,
            .ai-message td {
                padding: 6px 4px;
            }
            
            .ai-message .pdf-button {
                right: 50px;
                font-size: 0.65em;
                padding: 3px 6px;
            }
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: stretch;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 16px 24px;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            background: white;
            height: 44px;
            box-sizing: border-box;
        }

        .input-group input:focus {
            border-color: #0066CB;
            box-shadow: 0 0 0 2px rgba(0,102,203,0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #0066CB;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #DCA972;
            color: white;
        }

        .btn-secondary:hover {
            background: #c9975a;
        }

        .btn-edit {
            background: #123062;
            color: white;
            font-size: 0.8em;
            padding: 8px 16px;
        }

        .btn-edit:hover {
            background: #0f2750;
        }
        
        .btn-compact {
            padding: 6px 10px;
            font-size: 0.8em;
            min-width: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #0066CB;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #123062;
            font-size: 0.9em;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
        }

        .form-group input:focus, .form-group textarea:focus {
            border-color: #0066CB;
            box-shadow: 0 0 0 2px rgba(0,102,203,0.1);
            outline: none;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-footer .button-group {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .modal-footer .btn {
            padding: 8px 12px;
            font-size: 0.85em;
            min-width: auto;
            white-space: nowrap;
        }
        
        .modal-footer .btn-compact {
            padding: 6px 10px;
            font-size: 0.8em;
            min-width: 60px;
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .data-preview {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0066CB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive Design */
        @media screen and (max-width: 768px) {
            .container {
                max-width: 100%;
                margin: 0;
                min-height: 100vh;
                padding-bottom: 0;
            }
            
            body {
                margin-bottom: 0;
                padding-bottom: 0;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 1.4em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.8em;
            }

            .header img {
                height: 32px !important;
            }

            .modal-header img {
                height: 20px !important;
            }

            .btn-edit {
                font-size: 0.7em;
                padding: 6px 12px;
                margin-top: 8px;
            }

            .main-content {
                padding: 16px;
                padding-bottom: 0;
                margin-bottom: 0;
            }

            .chat-section {
                max-width: 100%;
            }

            .chat-container {
                padding: 16px;
                max-height: 400px;
                border-radius: 8px;
                padding-bottom: 80px; /* Space for floating input on mobile */
            }

            .message {
                font-size: 0.85em;
                padding: 10px 14px;
                margin-bottom: 12px;
            }

            .user-message {
                max-width: 70%;
                width: fit-content;
                min-width: 50px;
            }

            .ai-message {
                max-width: 90%;
                width: fit-content;
                min-width: 50px;
            }

            .input-group {
                flex-direction: row;
                gap: 8px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 12px 16px;
                background: white;
                border-top: 1px solid #e9ecef;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                z-index: 100;
                margin: 0;
            }

            .input-group input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px 14px;
                border-radius: 8px;
                height: 44px;
                flex: 1;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
                height: 44px;
                min-width: 60px;
            }

            .input-group .btn-secondary {
                min-width: 44px;
                padding: 12px;
            }

            .ai-message .copy-button {
                font-size: 0.6em;
                padding: 3px 6px;
            }

            /* Modal Mobile Optimization */
            .modal-content {
                width: 95%;
                margin: 10% auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-header h3 {
                font-size: 1.1em;
            }

            .modal-body {
                padding: 16px;
            }

            .form-group textarea {
                height: 90px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .modal-footer {
                padding: 16px;
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .button-group {
                flex-direction: column;
                gap: 6px;
            }

            .modal-footer .btn {
                width: 100%;
                padding: 10px 12px;
                font-size: 0.9em;
            }
            
            .modal-footer .btn-compact {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .modal-footer .data-preview {
                font-size: 0.75em;
                padding: 6px 10px;
                max-height: 60px;
            }

            .modal-footer #previewContent {
                font-size: 0.7em;
            }
            
            #loginForm .data-preview {
                font-size: 0.75em;
                padding: 6px 10px;
                max-height: 60px;
                margin-top: 12px;
            }

            #loginForm #previewContent {
                font-size: 0.7em;
            }

            .data-preview {
                font-size: 0.75em;
                max-height: 120px;
            }

            /* Mobile responsive for admin panel layout */
            #adminPanel .data-preview {
                font-size: 0.75em;
                padding: 6px 10px;
                max-height: 60px;
            }

            #adminPanel #previewContent {
                font-size: 0.7em;
            }
        }

        /* Small Mobile (iPhone SE, etc.) */
        @media screen and (max-width: 480px) {
            .container {
                padding-bottom: 0;
            }
            
            body {
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            .header {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .header img {
                height: 28px !important;
            }

            .modal-header img {
                height: 18px !important;
            }

            .main-content {
                padding: 12px;
                padding-bottom: 0;
                margin-bottom: 0;
            }

            .chat-container {
                padding: 12px;
                max-height: 350px;
                padding-bottom: 70px; /* Space for floating input on small mobile */
            }

            .message {
                font-size: 0.8em;
                padding: 8px 12px;
            }

            .user-message {
                max-width: 75%;
                width: fit-content;
                min-width: 40px;
            }

            .ai-message {
                max-width: 95%;
                width: fit-content;
                min-width: 40px;
            }

            .input-group {
                padding: 10px 12px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e9ecef;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                z-index: 100;
                margin: 0;
            }

            .input-group input {
                padding: 10px 12px;
                height: 40px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 0.85em;
                height: 40px;
                min-width: 70px;
            }

            .modal-content {
                width: 98%;
                margin: 5% auto;
            }

            .modal-header {
                padding: 12px;
            }

            .modal-body {
                padding: 12px;
            }

            .form-group textarea {
                height: 72px;
            }

            .modal-footer {
                padding: 12px;
            }

            #adminPanel .data-preview {
                font-size: 0.7em;
                padding: 5px 8px;
                max-height: 50px;
            }

            #adminPanel #previewContent {
                font-size: 0.65em;
            }
        }

        /* Landscape Mobile */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .container {
                padding-bottom: 0;
            }
            
            body {
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            .chat-container {
                max-height: 250px;
                padding-bottom: 60px; /* Space for floating input in landscape */
            }

            .input-group {
                padding: 8px 16px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e9ecef;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                z-index: 100;
                margin: 0;
            }

            .modal-content {
                margin: 2% auto;
                max-height: 95vh;
            }

            .form-group textarea {
                height: 60px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* Apple's recommended touch target size */
            }

            .close {
                font-size: 28px;
                padding: 8px;
            }

            .input-group input {
                min-height: 44px;
            }

            .input-group {
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Password Protection Modal -->
        <div id="passwordModal" class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="assets/Unilever_logo-onlytext.png" alt="Unilever" style="height: 24px; width: auto;">
                        <h3 style="margin: 0;">üîê DT Internal Masterdata Access</h3>
                    </div>
                </div>
                <div class="modal-body">
                    <p style="text-align: center; margin-bottom: 20px; color: #666;">
                        Hi and thank you for stopping by! This page is specially made for DT Internal team members.<br>
                        Please enter the access code to continue.
                    </p>
                    <div class="form-group">
                        <label for="accessPassword">Access Code:</label>
                        <input type="password" id="accessPassword" placeholder="Enter access code" onkeypress="handlePasswordKeyPress(event)">
                    </div>
                    <button class="btn btn-primary" onclick="checkPassword()" style="width: 100%;">Enter</button>
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.8em; color: #666;">
                        <strong>Need Access?</strong><br>
                        üìû Contact Ugi: +62 852-4228-3643<br>
                        üí¨ <a href="https://wa.me/+6285242283643" target="_blank" style="color: #0066CB;">WhatsApp</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px;">
                <img src="assets/unilever-blue-transparent-withtextunderlogo.png" alt="Unilever" style="height: 40px; width: auto;">
                <div>
                    <h1 style="margin: 0; font-size: 1.6em;">ü§ñ DT Internal Masterdata</h1>
                    <p style="margin: 4px 0 0 0; font-size: 0.85em;">AI-powered data management untuk internal team</p>
                </div>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 12px;">
                <button class="btn btn-edit" onclick="openAdminModal()">Edit Master Data</button>
                <button class="btn btn-secondary" onclick="logoutSession()" style="font-size: 0.7em; padding: 6px 12px;">Logout</button>
            </div>
            <div id="sessionInfo" style="font-size: 0.7em; margin-top: 8px; opacity: 0.8;"></div>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <strong>AI Assistant:</strong> Halo! Saya adalah AI Assistant untuk DT Internal Masterdata. Saya siap membantu menjawab pertanyaan Anda tentang data internal, master data, dan informasi yang tersimpan dalam sistem. Silakan tanyakan apa saja!
                        <br><br><small style="color: #28a745; font-weight: bold;">üîÑ Data akan otomatis di-sync dari server setiap kali refresh page dan saat kembali ke tab untuk memastikan Anda selalu mendapat informasi terbaru.</small>
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Tanyakan tentang data internal..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">Kirim</button>
                    <button class="btn btn-secondary" onclick="clearChatHistory()" style="padding: 12px; font-size: 0.8em;" title="Hapus riwayat chat">üóëÔ∏è</button>
                </div>
            </div>

        </div>
    </div>

        <!-- Admin Modal -->
        <div id="adminModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="assets/Unilever_logo-onlytext.png" alt="Unilever" style="height: 24px; width: auto;">
                        <h3 style="margin: 0;">‚öôÔ∏è Admin Panel</h3>
                    </div>
                    <span class="close" onclick="closeAdminModal()">&times;</span>
                </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="adminCode">Unlock Code:</label>
                        <input type="password" id="adminCode" placeholder="Masukkan unlock code" onkeypress="handleUnlockKeyPress(event)">
                    </div>
                    <button class="btn btn-primary" onclick="unlockAdmin()" style="width: 100%;">üîì Unlock Admin</button>

                    <div class="data-preview" id="dataPreview" style="margin-top: 15px; font-size: 0.8em; padding: 8px 12px; max-height: 80px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <strong>üìä Preview Data:</strong>
                        <div id="previewContent" style="margin-top: 4px; font-size: 0.75em; line-height: 1.3;">Belum ada data tersimpan</div>
                    </div>
                    </div>

                <div id="adminPanel" class="hidden">
                    <p style="margin: 0 0 12px 0;"><span class="status-indicator status-online"></span>Terhubung sebagai: <strong>ugi</strong> <span style="color: #28a745; font-weight: bold;">(Admin Mode)</span></p>
                    <p style="margin: 0 0 12px 0; font-size: 0.8em; color: #28a745;"><span class="status-indicator status-online"></span>Auto-sync: Hanya saat login/refresh, disabled saat admin edit</p>
                    <p style="margin: 0 0 12px 0; font-size: 0.7em; color: #666;">üí° Data tidak akan otomatis berubah saat Anda sedang edit</p>
                    
                    <div class="form-group">
                        <label for="masterData">üìã DT Internal Master Data:</label>
                        <textarea id="masterData" placeholder="Paste semua data internal di sini (Ctrl+V):&#10;&#10;Contoh format:&#10;=== INFORMASI PERUSAHAAN ===&#10;Nama: PT Unilever Indonesia&#10;Divisi: DT Internal&#10;Lokasi: Jakarta, Bandung, Surabaya...&#10;&#10;=== DATA OPERASIONAL ===&#10;Proses internal: 1. Data collection...&#10;Sistem: SAP, Oracle, Custom tools...&#10;&#10;=== FAQ & PANDUAN INTERNAL ===&#10;Q: Bagaimana cara akses data X?&#10;A: Login ke portal internal...&#10;&#10;=== INFORMASI KONTAK INTERNAL ===&#10;Email: dt.internal@unilever.com&#10;Ext: 1234&#10;Jam kerja: Senin-Jumat 08:00-17:00"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="button-group">
                    <button class="btn btn-secondary btn-compact" onclick="closeAdminModal()">Tutup</button>
                    <button class="btn btn-info btn-compact" onclick="showRAGStatus()" id="ragStatusBtn" style="display: none;">üîç RAG</button>
                    <button class="btn btn-warning btn-compact" onclick="forceLoadFromServer()" id="forceLoadBtn" style="display: none;">üîÑ Sync</button>
                    <button class="btn btn-primary btn-compact" onclick="saveData()" id="saveBtn" style="display: none;">üíæ Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io removed for production -->
    <script>
        // Access codes (internal use only)
        const ACCESS_PASSWORD = 'dtunilever2025';
        const ADMIN_UNLOCK_CODE = 'ugi354';
        const SESSION_DURATION = 365 * 24 * 60 * 60 * 1000; // 365 days (effectively permanent)

        let isAccessGranted = false;
        let isAdminLoggedIn = false;
        let conversationHistory = [];
        let socket = null;
        let currentMasterData = '';
        let customWelcomeMessage = null;
        let lastMasterDataHash = null;
        let isAdminEditing = false; // Flag to prevent sync during admin editing

        // Chat history management
        const CHAT_HISTORY_KEY = 'dt_chat_history';

        function saveChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            const messages = Array.from(chatContainer.children)
                .filter(msg => !msg.innerHTML.includes('AI Assistant: Halo! Saya adalah AI Assistant'))
                .map(msg => ({
                content: msg.innerHTML,
                className: msg.className
            }));
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        }

        function loadChatHistory() {
            const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedHistory) {
                try {
                    const messages = JSON.parse(savedHistory);
                    const chatContainer = document.getElementById('chatContainer');
                    
                    // Clear existing messages completely
                    chatContainer.innerHTML = '';
                    
                    // Add welcome message first
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'message ai-message';
                    welcomeDiv.innerHTML = '<strong>AI Assistant:</strong> Halo! Saya adalah AI Assistant untuk DT Internal Masterdata. Saya siap membantu menjawab pertanyaan Anda tentang data internal, master data, dan informasi yang tersimpan dalam sistem. Silakan tanyakan apa saja!<br><br><small style="color: #28a745; font-weight: bold;">üîÑ Data akan otomatis di-sync dari server setiap kali refresh page dan saat kembali ke tab untuk memastikan Anda selalu mendapat informasi terbaru.</small>';
                    chatContainer.appendChild(welcomeDiv);
                    
                    // Load saved messages (excluding welcome messages)
                    messages.forEach(msg => {
                        if (!msg.content.includes('AI Assistant: Halo! Saya adalah AI Assistant') && 
                            !msg.content.includes('Data akan otomatis di-sync dari server')) {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = msg.className;
                            messageDiv.innerHTML = msg.content;
                            
                            // Add copy button for AI messages
                            if (msg.className.includes('ai-message')) {
                                const copyButton = document.createElement('button');
                                copyButton.className = 'copy-button';
                                copyButton.textContent = 'üìã Copy';
                                copyButton.onclick = () => copyAIMessage(messageDiv);
                                messageDiv.appendChild(copyButton);
                            }
                            
                            chatContainer.appendChild(messageDiv);
                        }
                    });
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }
        }

        function clearChatHistory() {
            if (confirm('Apakah Anda yakin ingin menghapus semua riwayat chat?')) {
                localStorage.removeItem(CHAT_HISTORY_KEY);
                const chatContainer = document.getElementById('chatContainer');
                
                // Clear all messages and add fresh welcome message
                chatContainer.innerHTML = '';
                
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'message ai-message';
                welcomeDiv.innerHTML = '<strong>AI Assistant:</strong> Halo! Saya adalah AI Assistant untuk DT Internal Masterdata. Saya siap membantu menjawab pertanyaan Anda tentang data internal, master data, dan informasi yang tersimpan dalam sistem. Silakan tanyakan apa saja!<br><br><small style="color: #28a745; font-weight: bold;">üîÑ Data akan otomatis di-sync dari server setiap kali refresh page dan saat kembali ke tab untuk memastikan Anda selalu mendapat informasi terbaru.</small>';
                chatContainer.appendChild(welcomeDiv);
                
                // Clear conversation history for AI
                conversationHistory = [];
                
                alert('‚úÖ Riwayat chat berhasil dihapus!');
            }
        }

        // Format AI response text - SIMPLIFIED
        function formatAIResponse(text) {
            // Handle markdown tables first
            text = formatMarkdownTables(text);
            
            // Convert markdown bold (**text**) to HTML bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert line breaks to HTML breaks
            text = text.replace(/\n/g, '<br>');
            
            // Clean up excessive line breaks (max 2 consecutive)
            text = text.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            // Wrap in paragraph tags
            text = `<p>${text}</p>`;
            
            return text;
        }

        // Format markdown tables to HTML tables
        function formatMarkdownTables(text) {
            // Match markdown table pattern
            const tableRegex = /(\|.*\|(?:\s*\n\|.*\|)*)/g;
            
            return text.replace(tableRegex, (match) => {
                const lines = match.trim().split('\n').filter(line => line.trim());
                
                if (lines.length < 2) return match; // Need at least header and separator
                
                // Parse header row
                const headerCells = lines[0].split('|').slice(1, -1).map(cell => cell.trim());
                
                // Check if second line is a separator (contains only |, -, :, and spaces)
                const separatorLine = lines[1];
                if (!separatorLine.match(/^\|\s*:?-+:?\s*(\|\s*:?-+:?\s*)*\|$/)) {
                    return match; // Not a valid table separator
                }
                
                // Parse data rows
                const dataRows = lines.slice(2).map(line => 
                    line.split('|').slice(1, -1).map(cell => cell.trim())
                );
                
                // Ensure all rows have the same number of columns as header
                const maxColumns = headerCells.length;
                const normalizedDataRows = dataRows.map(row => {
                    while (row.length < maxColumns) {
                        row.push(''); // Add empty cells if needed
                    }
                    return row.slice(0, maxColumns); // Trim excess columns
                });
                
                // Build HTML table
                let htmlTable = '<table>';
                
                // Add header
                htmlTable += '<thead><tr>';
                headerCells.forEach(cell => {
                    // Escape HTML in cell content
                    const escapedCell = cell.replace(/&/g, '&amp;')
                                          .replace(/</g, '&lt;')
                                          .replace(/>/g, '&gt;')
                                          .replace(/"/g, '&quot;')
                                          .replace(/'/g, '&#39;');
                    htmlTable += `<th>${escapedCell}</th>`;
                });
                htmlTable += '</tr></thead>';
                
                // Add body
                htmlTable += '<tbody>';
                normalizedDataRows.forEach(row => {
                    htmlTable += '<tr>';
                    row.forEach(cell => {
                        // Escape HTML in cell content
                        const escapedCell = cell.replace(/&/g, '&amp;')
                                              .replace(/</g, '&lt;')
                                              .replace(/>/g, '&gt;')
                                              .replace(/"/g, '&quot;')
                                              .replace(/'/g, '&#39;');
                        htmlTable += `<td>${escapedCell}</td>`;
                    });
                    htmlTable += '</tr>';
                });
                htmlTable += '</tbody>';
                
                htmlTable += '</table>';
                
                return htmlTable;
            });
        }

        // Copy AI message content to clipboard
        function copyAIMessage(messageElement) {
            // Clone the message element to work with a copy
            const clonedElement = messageElement.cloneNode(true);
            
            // Remove the copy button from the cloned element
            const copyButton = clonedElement.querySelector('.copy-button');
            if (copyButton) {
                copyButton.remove();
            }
            
            // Get the message content without "AI Assistant:" prefix and without copy button text
            const messageText = clonedElement.textContent.replace(/^AI Assistant:\s*/, '').trim();
            
            // Copy to clipboard
            navigator.clipboard.writeText(messageText).then(() => {
                // Show success feedback
                const originalCopyButton = messageElement.querySelector('.copy-button');
                const originalText = originalCopyButton.textContent;
                
                // Clear the button content completely and set new text
                originalCopyButton.innerHTML = '‚úì Copied!';
                originalCopyButton.classList.add('copied');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    originalCopyButton.innerHTML = originalText;
                    originalCopyButton.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Gagal menyalin teks ke clipboard');
            });
        }

        // Session management functions
        function saveSession() {
            const sessionData = {
                timestamp: Date.now(),
                accessGranted: true,
                isAdmin: isAdminLoggedIn,
                masterData: currentMasterData,
                customWelcomeMessage: customWelcomeMessage,
                lastMasterDataHash: lastMasterDataHash
            };
            localStorage.setItem('dt_session', JSON.stringify(sessionData));
        }

        function loadSession() {
            const sessionData = localStorage.getItem('dt_session');
            if (!sessionData) return false;
            
            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                const sessionAge = now - session.timestamp;
                
                if (sessionAge < SESSION_DURATION) {
                    // Session masih valid
                    isAccessGranted = true;
                    isAdminLoggedIn = session.isAdmin || false;
                    currentMasterData = session.masterData || '';
                    customWelcomeMessage = session.customWelcomeMessage || null;
                    lastMasterDataHash = session.lastMasterDataHash || null;
                    
                    // Update welcome message if available
                    if (customWelcomeMessage) {
                        updateWelcomeMessage();
                    }
                    
                    return true;
                } else {
                    // Session expired
                    localStorage.removeItem('dt_session');
                    isAccessGranted = false;
                    isAdminLoggedIn = false;
                    return false;
                }
            } catch (error) {
                localStorage.removeItem('dt_session');
                isAccessGranted = false;
                isAdminLoggedIn = false;
                return false;
            }
        }

        function clearSession() {
            localStorage.removeItem('dt_session');
            isAccessGranted = false;
            isAdminLoggedIn = false;
            currentMasterData = '';
        }

        function logoutSession() {
            clearSession();
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('accessPassword').value = '';
            alert('üëã Logged out successfully!');
        }

        function updateSessionInfo() {
            const sessionData = localStorage.getItem('dt_session');
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const now = Date.now();
                    const sessionAge = now - session.timestamp;
                    const remainingTime = SESSION_DURATION - sessionAge;
                    
                    if (remainingTime > 0) {
                        const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                        const adminStatus = session.isAdmin ? ' (Admin Mode)' : '';
                        document.getElementById('sessionInfo').textContent = `Session expires in: ${hours}h ${minutes}m${adminStatus}`;
                    } else {
                        document.getElementById('sessionInfo').textContent = 'Session expired';
                    }
                } catch (error) {
                    document.getElementById('sessionInfo').textContent = '';
                }
            } else {
                document.getElementById('sessionInfo').textContent = '';
            }
        }

        function updateAdminStatus() {
            // Update admin button visibility
            const adminButton = document.querySelector('button[onclick="openAdminModal()"]');
            if (isAdminLoggedIn) {
                adminButton.textContent = 'Admin Mode ‚úì';
                adminButton.style.background = '#28a745';
            } else {
                adminButton.textContent = 'Edit Master Data';
                adminButton.style.background = '#123062';
            }
        }

        function checkSessionExpiry() {
            if (isAccessGranted && !loadSession()) {
                // Session expired, force logout
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                document.getElementById('accessPassword').value = '';
                alert('‚è∞ Session expired! Please enter access code again.');
            }
        }

        // Password protection functions
        function checkPassword() {
            const password = document.getElementById('accessPassword').value;
            
            if (password === ACCESS_PASSWORD) {
                isAccessGranted = true;
                saveSession();
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('userInput').focus();
                
                // Load master data from server only after successful login
                loadMasterData();
            } else {
                // Show detailed error with contact info
                const errorMessage = `‚ùå Access code salah!\n\nJika Anda memerlukan akses, silakan hubungi:\nüìû Ugi: +62 852-4228-3643\nüí¨ WhatsApp: wa.me/+6285242283643`;
                alert(errorMessage);
                document.getElementById('accessPassword').value = '';
            }
        }

        function handlePasswordKeyPress(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }

        // Initialize data loading (only sync on fresh page load)
        function initializeSocket() {
            // Load master data hanya saat fresh page load, tidak setiap kali
            // loadMasterData(); // Moved to specific events only
        }
        
        // Load master data from API - AUTO SYNC FOR ALL USERS
        function loadMasterData() {
            // Skip sync if admin is currently editing to prevent conflicts
            if (isAdminEditing) {
                console.log('Skipping sync - admin is currently editing');
                return;
            }
            
            // Show sync indicator
            const sessionInfo = document.getElementById('sessionInfo');
            const originalText = sessionInfo.textContent;
            sessionInfo.innerHTML = '<span class="loading"></span> Syncing master data...';
            
            // Add cache-busting parameter to ensure fresh data
            const timestamp = new Date().getTime();
            fetch(`/api/master-data?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Always load from server to ensure all users have latest data
                    const serverData = data.content || '';
                        currentMasterData = serverData;
                    
                    // Update master data field if admin panel is open
                    const masterDataField = document.getElementById('masterData');
                    if (masterDataField) {
                        masterDataField.value = currentMasterData;
                    }
                    
                    console.log('‚úÖ Master data synced from server for all users');
                    
                    // Generate custom welcome message based on latest data
                    generateCustomWelcomeMessage();
                    
                    updateDataPreview();
                    // Save to session
                    saveSession();
                    
                    // Show RAG status button for large data
                    if (currentMasterData && currentMasterData.length > 1000) {
                        const ragBtn = document.getElementById('ragStatusBtn');
                        if (ragBtn) ragBtn.style.display = 'inline-block';
                    } else {
                        const ragBtn = document.getElementById('ragStatusBtn');
                        if (ragBtn) ragBtn.style.display = 'none';
                    }
                    
                    // Always show force load button for admin
                    if (isAdminLoggedIn) {
                        const forceBtn = document.getElementById('forceLoadBtn');
                        if (forceBtn) forceBtn.style.display = 'inline-block';
                    }
                    
                    // Show sync success indicator
                    sessionInfo.innerHTML = '‚úÖ Data synced successfully';
                    setTimeout(() => {
                        sessionInfo.textContent = originalText;
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error loading master data:', error);
                    // Fallback to session data if API fails
                    if (currentMasterData) {
                        const masterDataField = document.getElementById('masterData');
                        if (masterDataField) masterDataField.value = currentMasterData;
                        updateDataPreview();
                    } else {
                        currentMasterData = '';
                        updateDataPreview();
                    }
                    
                    // Show sync error indicator
                    sessionInfo.innerHTML = '‚ùå Sync failed - using cached data';
                    setTimeout(() => {
                        sessionInfo.textContent = originalText;
                    }, 3000);
                });
        }

        // RAG Search function
        async function searchRAG(query, maxResults = 5) {
            try {
                const response = await fetch('/api/rag-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        maxResults: maxResults
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    return data.data;
                } else {
                    console.error('RAG search failed:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Error in RAG search:', error);
                return null;
            }
        }

        // Show RAG status
        async function showRAGStatus() {
            const masterData = document.getElementById('masterData').value;
            if (!masterData.trim()) {
                showNotification('‚ùå Tidak ada data untuk diproses', 'error');
                return;
            }
            
            try {
                // Test RAG search with a sample query
                const ragResult = await searchRAG('data', 3);
                if (ragResult) {
                    const status = `üîç RAG Status:\n` +
                        `üìä Total Chunks: ${ragResult.totalChunks}\n` +
                        `üéØ Search Results: ${ragResult.resultsCount}\n` +
                        `üìù Query: "${ragResult.query}"\n\n` +
                        `üìã Sample Chunks:\n` +
                        ragResult.chunks.map((chunk, index) => 
                            `${index + 1}. ${chunk.content.substring(0, 100)}...`
                        ).join('\n\n');
                    
                    alert(status);
                } else {
                    showNotification('‚ùå Gagal memproses RAG status', 'error');
                }
            } catch (error) {
                console.error('Error showing RAG status:', error);
                showNotification('‚ùå Error dalam RAG status', 'error');
            }
        }

        // Force load from server (overwrite local data)
        async function forceLoadFromServer() {
            if (confirm('‚ö†Ô∏è Ini akan mengganti data master yang ada dengan data dari server. Lanjutkan?')) {
                try {
                    const response = await fetch('/api/master-data');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Force overwrite local data
                    currentMasterData = data.content || '';
                    document.getElementById('masterData').value = currentMasterData;
                    updateDataPreview();
                    saveSession();
                    
                    // Generate new custom welcome message
                    await generateCustomWelcomeMessage();
                    
                    showNotification('‚úÖ Data berhasil dimuat dari server', 'success');
                } catch (error) {
                    console.error('Error force loading from server:', error);
                    showNotification('‚ùå Gagal memuat data dari server', 'error');
                }
            }
        }

        // Generate custom welcome message based on master data
        async function generateCustomWelcomeMessage() {
            if (!currentMasterData || currentMasterData.trim() === '') {
                customWelcomeMessage = null;
                return;
            }

            // Check if master data has changed
            const currentHash = await generateHash(currentMasterData);
            if (currentHash === lastMasterDataHash && customWelcomeMessage) {
                console.log('Master data unchanged, using cached welcome message');
                return;
            }

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Buatkan welcome message yang personal dan informatif untuk AI Assistant DT Internal Masterdata berdasarkan data berikut:\n\n${currentMasterData}\n\nBuatkan welcome message yang:\n1. Menyebutkan jenis data yang tersedia\n2. Menyebutkan topik-topik yang bisa ditanyakan\n3. Memberikan contoh pertanyaan yang relevan\n4. Tetap profesional dan ramah\n5. Maksimal 3-4 kalimat\n6. Gunakan format: "AI Assistant: [welcome message]"`
                    })
                });

                const data = await response.json();
                if (data.success) {
                    customWelcomeMessage = data.response;
                    lastMasterDataHash = currentHash;
                    console.log('Custom welcome message generated:', customWelcomeMessage);
                    
                    // Update welcome message in chat
                    updateWelcomeMessage();
                    saveSession();
                } else {
                    console.error('Failed to generate custom welcome message');
                }
            } catch (error) {
                console.error('Error generating custom welcome message:', error);
            }
        }

        // Generate hash for master data to detect changes
        async function generateHash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Update welcome message in chat
        function updateWelcomeMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const welcomeElement = chatContainer.querySelector('.ai-message:first-child');
            if (welcomeElement && customWelcomeMessage) {
                welcomeElement.innerHTML = formatAIResponse(customWelcomeMessage);
            }
        }

        // Initialize data from localStorage (for admin)
        function initializeData() {
            const savedData = localStorage.getItem('supplyChainData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('masterData').value = data.masterData || '';
                updateDataPreview();
            }
        }

        // Modal functions
        function openAdminModal() {
            // Check session validity first
            if (!loadSession()) {
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                alert('‚è∞ Session expired! Please enter access code again.');
                return;
            }
            
            document.getElementById('adminModal').style.display = 'block';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('saveBtn').style.display = 'none';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        // Unlock admin panel
        function unlockAdmin() {
            const unlockCode = document.getElementById('adminCode').value;

            if (unlockCode === ADMIN_UNLOCK_CODE) {
                isAdminLoggedIn = true;
                saveSession(); // Save admin status to session
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('saveBtn').style.display = 'inline-block';
                
                // Load master data from server
                loadMasterData();
                
                // Set up admin editing detection
                setupAdminEditingDetection();
                
                updateAdminStatus();
            } else {
                alert('‚ùå Unlock code salah!');
            }
        }

        // Handle Enter key for unlock
        function handleUnlockKeyPress(event) {
            if (event.key === 'Enter') {
                unlockAdmin();
            }
        }

        // Set up admin editing detection
        function setupAdminEditingDetection() {
            const masterDataField = document.getElementById('masterData');
            if (masterDataField) {
                // Detect when admin starts editing
                masterDataField.addEventListener('focus', function() {
                    isAdminEditing = true;
                    console.log('Admin started editing - sync disabled');
                    updateAdminEditingStatus();
                });
                
                // Detect when admin stops editing (after 3 seconds of inactivity)
                let editingTimeout;
                masterDataField.addEventListener('input', function() {
                    isAdminEditing = true;
                    clearTimeout(editingTimeout);
                    editingTimeout = setTimeout(function() {
                        isAdminEditing = false;
                        console.log('Admin stopped editing - sync enabled');
                        updateAdminEditingStatus();
                    }, 3000); // Increased to 3 seconds
                });
                
                // Detect when admin leaves the field
                masterDataField.addEventListener('blur', function() {
                    setTimeout(function() {
                        isAdminEditing = false;
                        console.log('Admin left field - sync enabled');
                        updateAdminEditingStatus();
                    }, 1000);
                });
            }
        }
        
        // Update admin editing status display
        function updateAdminEditingStatus() {
            const statusElement = document.querySelector('#adminPanel p:nth-child(2)');
            if (statusElement) {
                if (isAdminEditing) {
                    statusElement.innerHTML = '<span class="status-indicator status-offline"></span>Auto-sync: <strong>DISABLED</strong> - Admin sedang edit';
                    statusElement.style.color = '#dc3545';
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-online"></span>Auto-sync: Hanya saat login/refresh, disabled saat admin edit';
                    statusElement.style.color = '#28a745';
                }
            }
        }

        // Lock admin panel
        function logoutAdmin() {
            isAdminLoggedIn = false;
            isAdminEditing = false; // Reset editing flag
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminCode').value = '';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('adminModal');
            if (event.target === modal) {
                closeAdminModal();
            }
        }

        // Mobile-specific improvements
        function handleMobileInput() {
            // Prevent zoom on iOS when focusing input
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 768) {
                        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
            });
        }

        // Test function for table formatting (can be called from browser console)
        function testTableFormatting() {
            const testTable = `| No. | Informasi | Data |
|-----|-----------|------|
| 1. | Merek Produk | 43 merek |
| 2. | Toko Penjualan | 3,2 juta toko |
| 3. | Pendapatan 2023 | IDR 38,6 triliun |
| 4. | Kapitalisasi Pasar | #12 di IDX |`;
            
            addMessageToChat(testTable, 'ai');
        }

        // Generate PDF from AI message with AI-powered content processing
        async function generatePDF(messageElement, originalMessage) {
            const pdfButton = messageElement.querySelector('.pdf-button');
            const originalText = pdfButton.textContent;
            
            try {
                // Disable button and show loading
                pdfButton.disabled = true;
                pdfButton.textContent = 'ü§ñ AI Processing...';
                
                // AI-powered content cleaning and formatting
                const aiProcessedContent = await processContentWithAI(originalMessage);
                
                // AI-powered chart analysis and generation
                const chartSuggestions = await analyzeDataWithAI(originalMessage);
                console.log('AI detected chart opportunities:', chartSuggestions);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font to Times New Roman
                doc.setFont('times');
                
                // Add logo using base64 or direct image loading
                try {
                    // Try multiple logo options
                    let logoResponse;
                    let logoFormat = 'PNG';
                    
                    try {
                        logoResponse = await fetch('assets/unilever-2-logo-png-transparent.png');
                        if (!logoResponse.ok) throw new Error('First logo failed');
                    } catch (e) {
                        try {
                            logoResponse = await fetch('assets/Unilever_logo-onlytext.png');
                            if (!logoResponse.ok) throw new Error('Second logo failed');
                        } catch (e2) {
                            logoResponse = await fetch('assets/unilever-blue-transparent-withtextunderlogo.png');
                            if (!logoResponse.ok) throw new Error('All logos failed');
                        }
                    }
                    
                    const logoBlob = await logoResponse.blob();
                    const logoArrayBuffer = await logoBlob.arrayBuffer();
                    const logoBase64 = btoa(String.fromCharCode(...new Uint8Array(logoArrayBuffer)));
                    
                    // Add logo to PDF with original size
                    doc.addImage(`data:image/png;base64,${logoBase64}`, logoFormat, 20, 15);
                    console.log('Logo added successfully to PDF');
                } catch (error) {
                    console.log('All logos failed, using text header:', error);
                    // Fallback to text header
                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.setTextColor(0, 102, 203);
                    doc.text('UNILEVER', 20, 20);
                }
                
                // Add elegant Unilever header
                doc.setFontSize(16);
                doc.setFont('times', 'bold');
                doc.setTextColor(0, 102, 203); // Unilever blue
                doc.text('Unilever Masterdata', 50, 30);
                
                // Add subtitle with elegant styling
                doc.setFontSize(11);
                doc.setFont('times', 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('Data Intelligence & Analytics Report', 50, 37);
                
                // Add date with better formatting
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${new Date().toLocaleString('id-ID')}`, 50, 44);
                
                // Add elegant line separator with Unilever blue
                doc.setDrawColor(0, 102, 203);
                doc.setLineWidth(0.8);
                doc.line(20, 48, 190, 48);
                
                // Add subtle secondary line
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.2);
                doc.line(20, 49, 190, 49);
                
                // Add margin guidelines (invisible but helps with layout)
                doc.setDrawColor(240, 240, 240);
                doc.setLineWidth(0.1);
                doc.line(20, 50, 20, 280); // Left margin
                doc.line(170, 50, 170, 280); // Right margin
                
                // Process AI-cleaned content for PDF with proper formatting
                // Use proper margins - left: 20, right: 20, so content width = 140
                const lines = doc.splitTextToSize(aiProcessedContent, 140); // Reduced width to prevent overlapping
                let yPosition = 60;
                
                // Set main content font
                doc.setFontSize(12);
                doc.setFont('times', 'normal');
                doc.setTextColor(0, 0, 0);
                
                for (let i = 0; i < lines.length; i++) {
                    if (yPosition > 270) { // Better page break management
                        doc.addPage();
                        yPosition = 30;
                        
                        // Add page header for subsequent pages
                        doc.setFontSize(10);
                        doc.setFont('times', 'italic');
                        doc.setTextColor(0, 102, 203);
                        doc.text('Unilever Masterdata - Page ' + (doc.internal.getCurrentPageInfo().pageNumber), 20, 20);
                        doc.setDrawColor(0, 102, 203);
                        doc.setLineWidth(0.3);
                        doc.line(20, 25, 190, 25);
                        
                        // Reset to content font
                        doc.setFontSize(12);
                        doc.setFont('times', 'normal');
                        doc.setTextColor(0, 0, 0);
                        yPosition = 30;
                    }
                    
                    // Better line spacing and positioning with justify alignment
                    const line = lines[i];
                    
                    // Check if it's a numbered list item
                    if (line.match(/^\d+\.\s*$/)) {
                        // This is a broken numbered list, skip it
                        continue;
                    }
                    
                    // Add proper margins and justify text with better line handling
                    if (line.length > 80) {
                        // Split very long lines to prevent overlapping
                        const words = line.split(' ');
                        let currentLine = '';
                        let lineHeight = 0;
                        
                        for (let word of words) {
                            if ((currentLine + ' ' + word).length > 70) {
                                if (currentLine) {
                                    doc.text(currentLine, 20, yPosition + lineHeight, { 
                                        align: 'justify',
                                        maxWidth: 140
                                    });
                                    lineHeight += 6;
                                }
                                currentLine = word;
                            } else {
                                currentLine += (currentLine ? ' ' : '') + word;
                            }
                        }
                        
                        if (currentLine) {
                            doc.text(currentLine, 20, yPosition + lineHeight, { 
                                align: 'justify',
                                maxWidth: 140
                            });
                        }
                        
                        yPosition += lineHeight + 6;
                    } else {
                        // Normal line processing
                        doc.text(line, 20, yPosition, { 
                            align: 'justify',
                            maxWidth: 140 // Ensure text doesn't exceed right margin
                        });
                        yPosition += 6;
                    }
                }
                
                // Add AI-suggested charts
                if (chartSuggestions.length > 0) {
                    yPosition += 10; // Add space before charts
                    
                    for (let i = 0; i < chartSuggestions.length; i++) {
                        const chartSuggestion = chartSuggestions[i];
                        
                        // Check if we need a new page for the chart
                        if (yPosition > 200) {
                            doc.addPage();
                            yPosition = 30;
                            
                            // Add page header
                            doc.setFontSize(10);
                            doc.setFont('times', 'italic');
                            doc.setTextColor(0, 102, 203);
                            doc.text('Unilever Masterdata - Page ' + (doc.internal.getCurrentPageInfo().pageNumber), 20, 20);
                            doc.setDrawColor(0, 102, 203);
                            doc.setLineWidth(0.3);
                            doc.line(20, 25, 190, 25);
                            
                            yPosition = 30;
                        }
                        
                        try {
                            // Generate chart
                            const chartImage = await generateChart(chartSuggestion);
                            
                            // Add chart title
                            doc.setFontSize(12);
                            doc.setFont('times', 'bold');
                            doc.setTextColor(0, 0, 0);
                            doc.text(chartSuggestion.title, 20, yPosition);
                            yPosition += 10;
                            
                            // Add chart to PDF
                            doc.addImage(chartImage, 'PNG', 20, yPosition, 160, 100);
                            yPosition += 110; // Space after chart
                            
                            // Add chart description
                            doc.setFontSize(9);
                            doc.setFont('times', 'italic');
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Grafik ${i + 1}: ${chartSuggestion.reason}`, 20, yPosition);
                            yPosition += 15;
                            
                        } catch (error) {
                            console.error('Error generating chart:', error);
                            // Continue without chart if generation fails
                        }
                    }
                }
                
                // Add elegant footer
                doc.setFontSize(8);
                doc.setFont('times', 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text('This file was retrieved by Unilever Masterdata System for internal use only.', 20, 290);
                doc.text('Confidential and proprietary information of Unilever Indonesia Tbk.', 20, 295);
                
                // Save PDF
                doc.save(`Unilever_Masterdata_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Gagal membuat PDF. Silakan coba lagi.');
            } finally {
                // Reset button
                pdfButton.disabled = false;
                pdfButton.textContent = originalText;
            }
        }

        // AI-powered content processing for PDF
        async function processContentWithAI(content) {
            const systemPrompt = `You are an AI assistant specialized in cleaning and formatting content for professional PDF reports. Your task is to:

1. REMOVE unnecessary content like:
   - "Jika ada yang perlu dijelaskan lebih lanjut atau pertanyaan lain, silakan beritahu saya."
   - "Silakan tanyakan jika ada yang kurang jelas."
   - "Apakah ada hal lain yang ingin Anda ketahui?"
   - Similar closing phrases and conversational elements

2. CLEAN and FORMAT the content for professional PDF:
   - Fix broken sentences and paragraphs
   - Ensure proper spacing between sections
   - PRESERVE numbered lists structure (1. 2. 3. etc.) - DO NOT change numbering
   - Remove redundant information
   - Make content concise but comprehensive
   - REMOVE ONLY markdown symbols: **text** becomes text (remove **), ### becomes plain text
   - Fix line breaks and prevent text overlapping
   - Convert **bold** text to plain text
   - Remove all ### ## # headers and make them plain text
   - KEEP the original numbering sequence intact

3. STRUCTURE the content logically:
   - Clear section headers
   - Proper paragraph breaks
   - Well-formatted lists with proper indentation
   - Professional tone
   - Each key point should be clearly separated

4. PRESERVE important data and information while removing fluff.

5. FORMAT for PDF:
   - Use proper line breaks
   - Ensure text doesn't overlap
   - Use consistent spacing
   - Make each key point distinct

Return ONLY the cleaned and formatted content, ready for PDF generation.`;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Please clean and format this content for a professional PDF report:\n\n${content}`,
                        systemPrompt: systemPrompt,
                        conversationHistory: []
                    })
                });

                const data = await response.json();
                if (data.success) {
                    return data.response;
                } else {
                    console.warn('AI content processing failed, using fallback');
                    return content; // Fallback to original content
                }
            } catch (error) {
                console.error('Error in AI content processing:', error);
                return content; // Fallback to original content
            }
        }

        // AI-powered data analysis for chart generation
        async function analyzeDataWithAI(content) {
            const systemPrompt = `You are an AI data analyst specialized in creating charts for each key point in business reports. Your task is to:

1. ANALYZE the content and identify KEY POINTS (not overall trends):
   - Look for numbered sections like "1. **Pertumbuhan Penjualan Total**"
   - Each key point should get its own chart
   - Focus on specific metrics, not general trends

2. FOR EACH KEY POINT, create a separate chart:
   - Extract the specific data points within that key point
   - Don't combine different key points into one chart
   - Each chart should represent ONE specific metric or category

3. DETERMINE appropriate chart types per key point:
   - Pie Chart: for percentages and proportions within one key point
   - Bar Chart: for comparisons within one key point
   - Line Chart: only if the key point shows time series data

4. EXTRACT data in this EXACT format (follow this structure precisely):
   {
     "charts": [
       {
         "type": "pie",
         "title": "Pertumbuhan Penjualan Total (termasuk Ekspor)",
         "data": [
           {"label": "UPG", "value": "-4.9%"},
           {"label": "UVG", "value": "+0.2%"},
           {"label": "Total", "value": "-4.7%"}
         ],
         "reason": "Data persentase cocok untuk pie chart"
       },
       {
         "type": "bar",
         "title": "Gross Margin Q1 2024",
         "data": [
           {"label": "Persentase", "value": "49.9%"},
           {"label": "Kenaikan vs LY", "value": "61 bps"},
           {"label": "Kenaikan vs L3M", "value": "156 bps"}
         ],
         "reason": "Data margin cocok untuk bar chart"
       },
       {
         "type": "bar",
         "title": "Pertumbuhan Penjualan Domestik",
         "data": [
           {"label": "Penjualan Domestik", "value": "-5.0%"},
           {"label": "Penjualan Ekspor", "value": "-14.0%"},
           {"label": "Dampak GM", "value": "0.0%"}
         ],
         "reason": "Data penjualan cocok untuk bar chart"
       }
     ]
   }

5. EXAMPLES of what to create:
   - Key Point 1: "Pertumbuhan Penjualan Total" ‚Üí Chart with UPG, UVG, Total data
   - Key Point 2: "Gross Margin Q1 2024" ‚Üí Chart with different margin metrics
   - Key Point 3: "Penjualan Domestik" ‚Üí Chart with domestic vs export data

6. STRICT RULES - DO NOT create:
   - Overall trend charts
   - Combined charts from different key points
   - Generic "all data" charts
   - "Trend Keseluruhan Data" charts
   - Any chart that combines multiple key points
   - Line charts unless the key point specifically shows time series data

7. FOCUS on individual key points only:
   - Each chart must represent ONE specific key point
   - Extract data ONLY from within that key point
   - Create separate charts for each key point
   - Make charts insightful and specific to that key point

Return ONLY the JSON response with chart suggestions for each key point.`;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Analyze this content and suggest appropriate charts for data visualization:\n\n${content}`,
                        systemPrompt: systemPrompt,
                        conversationHistory: []
                    })
                });

                const data = await response.json();
                if (data.success) {
                    try {
                        const chartData = JSON.parse(data.response);
                        return chartData.charts || [];
                    } catch (parseError) {
                        console.warn('Failed to parse AI chart response, no charts will be generated');
                        return []; // No fallback, let AI handle everything
                    }
                } else {
                    console.warn('AI chart analysis failed, no charts will be generated');
                    return []; // No fallback, let AI handle everything
                }
            } catch (error) {
                console.error('Error in AI chart analysis:', error);
                return []; // No fallback, let AI handle everything
            }
        }

        // Note: Hardcode fallback removed - AI handles all chart decisions

        // Generate chart based on data analysis
        function generateChart(chartSuggestion) {
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            canvas.style.display = 'none';
            document.body.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Unilever color palette
            const unileverColors = [
                '#0066CB', // Unilever blue
                '#00A651', // Green
                '#FF6B35', // Orange
                '#8E44AD', // Purple
                '#E74C3C', // Red
                '#F39C12', // Yellow
                '#1ABC9C', // Teal
                '#95A5A6'  // Gray
            ];
            
            // Process AI-suggested data for chart with better validation
            const labels = chartSuggestion.data.map(item => 
                (item.label || 'Unknown').substring(0, 20) // Limit label length
            );
            const values = chartSuggestion.data.map(item => {
                let val = (item.value || '0').replace(/[^\d.,-]/g, ''); // Keep negative signs
                val = val.replace(',', '.');
                const numVal = parseFloat(val);
                return isNaN(numVal) ? 0 : numVal;
            });
            
            // Filter out invalid data points
            const validData = labels.map((label, index) => ({
                label: label,
                value: values[index]
            })).filter(item => item.value !== 0 && item.label.trim() !== '');
            
            if (validData.length < 2) {
                throw new Error('Not enough valid data for chart');
            }
            
            const finalLabels = validData.map(item => item.label);
            const finalValues = validData.map(item => item.value);
            
            let chartConfig;
            
            switch (chartSuggestion.type) {
                case 'pie':
                    chartConfig = {
                        type: 'pie',
                        data: {
                            labels: finalLabels,
                            datasets: [{
                                data: finalValues,
                                backgroundColor: unileverColors.slice(0, finalValues.length),
                                borderColor: '#ffffff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartSuggestion.title,
                                    font: {
                                        size: 16,
                                        family: 'Times New Roman'
                                    }
                                },
                                legend: {
                                    position: 'right',
                                    labels: {
                                        font: {
                                            family: 'Times New Roman'
                                        }
                                    }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'bar':
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: finalLabels,
                            datasets: [{
                                label: 'Nilai',
                                data: finalValues,
                                backgroundColor: unileverColors[0],
                                borderColor: unileverColors[0],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartSuggestion.title,
                                    font: {
                                        size: 16,
                                        family: 'Times New Roman'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        font: {
                                            family: 'Times New Roman'
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            family: 'Times New Roman'
                                        }
                                    }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'line':
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: finalLabels,
                            datasets: [{
                                label: 'Trend',
                                data: finalValues,
                                borderColor: unileverColors[0],
                                backgroundColor: unileverColors[0] + '20',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartSuggestion.title,
                                    font: {
                                        size: 16,
                                        family: 'Times New Roman'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        font: {
                                            family: 'Times New Roman'
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            family: 'Times New Roman'
                                        }
                                    }
                                }
                            }
                        }
                    };
                    break;
            }
            
            const chart = new Chart(ctx, chartConfig);
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    const imageData = canvas.toDataURL('image/png');
                    document.body.removeChild(canvas);
                    resolve(imageData);
                }, 1000);
            });
        }

        // Format content for PDF using clean, readable formatting
        async function formatContentForPDF(content) {
            // Clean and format the content for better PDF presentation
            let formatted = content;
            
            // Remove ALL markdown formatting aggressively
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove **bold** markdown
            formatted = formatted.replace(/\*(.*?)\*/g, '$1'); // Remove *italic* markdown
            formatted = formatted.replace(/###\s*(.*)/g, '$1'); // Remove ### headers
            formatted = formatted.replace(/##\s*(.*)/g, '$1'); // Remove ## headers
            formatted = formatted.replace(/#\s*(.*)/g, '$1'); // Remove # headers
            formatted = formatted.replace(/`(.*?)`/g, '$1'); // Remove `code` markdown
            formatted = formatted.replace(/\[(.*?)\]\(.*?\)/g, '$1'); // Remove [link](url) markdown
            formatted = formatted.replace(/---+/g, ''); // Remove horizontal rules
            formatted = formatted.replace(/\*\s+/g, ''); // Remove bullet points
            formatted = formatted.replace(/^\s*[-*+]\s+/gm, ''); // Remove list markers
            
            // Handle markdown tables properly with clean formatting
            const tableRegex = /(\|.*\|(?:\s*\n\|.*\|)*)/g;
            formatted = formatted.replace(tableRegex, (match) => {
                const lines = match.trim().split('\n').filter(line => line.trim());
                
                if (lines.length < 2) return match;
                
                // Parse table data
                const headerCells = lines[0].split('|').slice(1, -1).map(cell => cell.trim());
                const separatorLine = lines[1];
                
                // Check if it's a valid table
                if (!separatorLine.match(/^\|\s*:?-+:?\s*(\|\s*:?-+:?\s*)*\|$/)) {
                    return match;
                }
                
                const dataRows = lines.slice(2).map(line => 
                    line.split('|').slice(1, -1).map(cell => cell.trim())
                );
                
                // Format as clean table
                let tableText = '\n\n';
                
                // Add table title
                tableText += 'TABEL DATA INFORMASI\n';
                tableText += '='.repeat(60) + '\n\n';
                
                // Add header with proper spacing
                const headerText = headerCells.map(cell => cell.padEnd(20)).join(' | ');
                tableText += headerText + '\n';
                tableText += '-'.repeat(headerText.length) + '\n';
                
                // Add data rows
                dataRows.forEach(row => {
                    const rowText = row.map(cell => cell.padEnd(20)).join(' | ');
                    tableText += rowText + '\n';
                });
                
                tableText += '\n';
                return tableText;
            });
            
            // Clean up content for better readability
            formatted = formatted.replace(/\n\s*\n/g, '\n\n'); // Clean up multiple line breaks
            formatted = formatted.replace(/[ \t]+/g, ' '); // Clean up multiple spaces
            
            // Better text wrapping for long sentences
            formatted = formatted.replace(/([.!?])\s*([A-Z][a-z])/g, '$1\n\n$2'); // Paragraph breaks
            formatted = formatted.replace(/([a-z])\s+([A-Z][a-z])/g, '$1 $2'); // Fix broken words
            
            // Better paragraph and section formatting - PRESERVE numbering
            formatted = formatted.replace(/(\d+\.\s+[^\n]+)/g, '\n\n$1'); // Add spacing before numbered lists
            formatted = formatted.replace(/([.!?])\s*([A-Z])/g, '$1 $2'); // Proper sentence spacing
            formatted = formatted.replace(/([.!?])\s*([A-Z][a-z])/g, '$1\n\n$2'); // Paragraph breaks
            
            // Fix broken numbered lists - merge separated numbers with content
            formatted = formatted.replace(/(\d+\.)\s*\n\s*([^\n])/g, '$1 $2');
            
            // Clean up list formatting - PRESERVE original numbering
            formatted = formatted.replace(/(\d+\.\s+)/g, '$1'); // Clean numbered lists but keep numbers
            formatted = formatted.replace(/([a-zA-Z])\s*-\s*([a-zA-Z])/g, '$1 - $2'); // Clean bullet points
            
            // Ensure numbered lists are properly formatted
            formatted = formatted.replace(/(\d+)\.\s*([^\n]+)/g, '$1. $2'); // Ensure proper spacing after numbers
            
            // Remove excessive line breaks
            formatted = formatted.replace(/\n{3,}/g, '\n\n'); // Max 2 line breaks
            
            // BAN ALL * and # symbols completely for PDF - ULTRA CLEAN
            formatted = formatted.replace(/\*/g, ''); // Remove ALL asterisks
            formatted = formatted.replace(/#/g, ''); // Remove ALL hash symbols
            formatted = formatted.replace(/_/g, ''); // Remove ALL underscores
            formatted = formatted.replace(/`/g, ''); // Remove ALL backticks
            formatted = formatted.replace(/\[/g, ''); // Remove ALL opening brackets
            formatted = formatted.replace(/\]/g, ''); // Remove ALL closing brackets
            formatted = formatted.replace(/\(/g, ''); // Remove ALL opening parentheses
            formatted = formatted.replace(/\)/g, ''); // Remove ALL closing parentheses
            
            // Clean up the final content
            formatted = formatted.trim();
            
            return formatted;
        }

        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            handleMobileInput();
            
            // Check session on page load
            if (loadSession()) {
                // Session valid, hide password modal
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('userInput').focus();
                
                // Load chat history
                loadChatHistory();
                
                // Load master data from server only on fresh page load
                loadMasterData();
                
                // Update admin status if logged in as admin
                if (isAdminLoggedIn) {
                    updateAdminStatus();
                }
            } else {
                // No valid session, show password modal
                document.getElementById('passwordModal').style.display = 'block';
            }
            
            // Check session expiry every 5 minutes
            setInterval(checkSessionExpiry, 5 * 60 * 1000);
            
            // Update session info every minute
            setInterval(updateSessionInfo, 60 * 1000);
            updateSessionInfo(); // Initial update
            
            // Auto-sync 2 menit dihapus untuk mencegah konflik dengan admin editing
            // setInterval(loadMasterData, 2 * 60 * 1000); // Disabled to prevent admin conflicts
            
            // Event listeners dihapus untuk mencegah gangguan saat admin edit
            // Hanya sync saat page load/refresh dan login saja
            
            // Prevent double-tap zoom on buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    button.click();
                });
            });
        });

        // Save data to server (admin only)
        async function saveData() {
            const masterDataContent = document.getElementById('masterData').value;
            
            if (!masterDataContent.trim()) {
                alert('Master data tidak boleh kosong!');
                return;
            }

            try {
                const response = await fetch('/api/master-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: masterDataContent,
                        updatedBy: 'ugi'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update current master data
                    currentMasterData = masterDataContent;
                    
                    // Save to session
                    saveSession();
                    
                    // Save to localStorage as backup
                    const data = {
                        masterData: masterDataContent,
                        lastUpdated: new Date().toLocaleString()
                    };
                    localStorage.setItem('supplyChainData', JSON.stringify(data));
                    
                    updateDataPreview();
                    
                    // Force sync after successful save
                    isAdminEditing = false; // Reset editing flag
                    loadMasterData();
                    
                    alert('‚úÖ Master data berhasil disimpan dan disinkronkan ke semua user!');
                } else {
                    alert('‚ùå Gagal menyimpan data: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('‚ùå Gagal menyimpan data. Periksa koneksi server.');
            }
        }

        // Update data preview
        function updateDataPreview() {
            let preview = '';
            
            if (currentMasterData) {
                preview += `üìã Master Data: ${currentMasterData.substring(0, 200)}...<br>`;
                preview += `<br><small>Status: ${isAdminLoggedIn ? 'Admin Mode' : 'Visitor Mode'}</small>`;
            } else {
                preview = 'Belum ada data tersimpan';
            }
            
            document.getElementById('previewContent').innerHTML = preview;
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message to AI
        async function sendMessage() {
            // Check session validity first
            if (!loadSession()) {
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                alert('‚è∞ Session expired! Please enter access code again.');
                return;
            }
            
            if (!isAccessGranted) {
                alert('‚ùå Please enter access code first!');
                return;
            }
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            userInput.value = '';

            // Show loading indicator
            const loadingId = addLoadingMessage();

            try {
                // Call backend API for AI chat with master data context
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory,
                        masterData: currentMasterData || ''
                    })
                });

                const data = await response.json();
                
                // Remove loading message
                removeLoadingMessage(loadingId);

                if (data.success) {
                    const aiResponse = data.response;
                    addMessageToChat(aiResponse, 'ai');
                    
                    // Add to conversation history
                    conversationHistory.push(
                        { role: "user", content: message },
                        { role: "assistant", content: aiResponse }
                    );

                    // Keep only last 10 exchanges to manage token usage
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }
                } else {
                    addMessageToChat('Maaf, terjadi kesalahan dalam memproses permintaan Anda. Silakan coba lagi.', 'ai');
                }

            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage(loadingId);
                addMessageToChat('Maaf, terjadi kesalahan koneksi. Pastikan koneksi internet Anda stabil dan coba lagi.', 'ai');
            }
        }

        // Add message to chat container
        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const senderName = sender === 'user' ? 'Anda' : 'AI Assistant';
            
            // Format AI response if it's from AI
            if (sender === 'ai') {
                const formattedMessage = formatAIResponse(message);
                messageDiv.innerHTML = `<strong>${senderName}:</strong> ${formattedMessage}`;
                
                // Add copy button for AI messages
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'üìã Copy';
                copyButton.onclick = () => copyAIMessage(messageDiv);
                messageDiv.appendChild(copyButton);
                
                // Add PDF button for AI messages
                const pdfButton = document.createElement('button');
                pdfButton.className = 'pdf-button';
                pdfButton.textContent = 'üìÑ PDF';
                pdfButton.onclick = () => generatePDF(messageDiv, message);
                messageDiv.appendChild(pdfButton);
            } else {
                messageDiv.innerHTML = `<strong>${senderName}:</strong> ${message}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Save chat history after adding message
            saveChatHistory();
        }

        // Add loading message
        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message ai-message';
            loadingDiv.innerHTML = '<strong>AI Assistant:</strong> <span class="loading"></span> Sedang memproses...';
            
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return loadingId;
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeData();
            // Load master data only on initial page load (not on every DOMContentLoaded)
            // loadMasterData(); // Moved to session check to prevent conflicts
        });
    </script>
</body>
</html>