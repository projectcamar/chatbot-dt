<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>UNVR DT AIMasterdata</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #123062;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #0066CB;
            color: white;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,102,203,0.2);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-container {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 500px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .user-message {
            background: #0066CB;
            color: white;
            margin-left: auto;
            text-align: right;
            max-width: 60%;
            width: fit-content;
            min-width: 60px;
        }

        .ai-message {
            background: #f1f3f4;
            color: #123062;
            border: 1px solid #e9ecef;
            max-width: 85%;
            width: fit-content;
            min-width: 60px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            background: white;
            height: 44px;
            box-sizing: border-box;
        }

        .input-group input:focus {
            border-color: #0066CB;
            box-shadow: 0 0 0 2px rgba(0,102,203,0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #0066CB;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #DCA972;
            color: white;
        }

        .btn-secondary:hover {
            background: #c9975a;
        }

        .btn-edit {
            background: #123062;
            color: white;
            font-size: 0.8em;
            padding: 8px 16px;
        }

        .btn-edit:hover {
            background: #0f2750;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #0066CB;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #123062;
            font-size: 0.9em;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
        }

        .form-group input:focus, .form-group textarea:focus {
            border-color: #0066CB;
            box-shadow: 0 0 0 2px rgba(0,102,203,0.1);
            outline: none;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .data-preview {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0066CB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive Design */
        @media screen and (max-width: 768px) {
            .container {
                max-width: 100%;
                margin: 0;
                min-height: 100vh;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 1.4em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 0.8em;
            }

            .header img {
                height: 32px !important;
            }

            .modal-header img {
                height: 20px !important;
            }

            .btn-edit {
                font-size: 0.7em;
                padding: 6px 12px;
                margin-top: 8px;
            }

            .main-content {
                padding: 16px;
            }

            .chat-section {
                max-width: 100%;
            }

            .chat-container {
                padding: 16px;
                max-height: 400px;
                border-radius: 8px;
            }

            .message {
                font-size: 0.85em;
                padding: 10px 14px;
                margin-bottom: 12px;
            }

            .user-message {
                max-width: 70%;
                width: fit-content;
                min-width: 50px;
            }

            .ai-message {
                max-width: 90%;
                width: fit-content;
                min-width: 50px;
            }

            .input-group {
                flex-direction: row;
                gap: 8px;
            }

            .input-group input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px 14px;
                border-radius: 8px;
                height: 44px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
                height: 44px;
                min-width: 80px;
            }

            /* Modal Mobile Optimization */
            .modal-content {
                width: 95%;
                margin: 10% auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-header h3 {
                font-size: 1.1em;
            }

            .modal-body {
                padding: 16px;
            }

            .form-group textarea {
                height: 90px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .modal-footer {
                padding: 16px;
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
            }

            .data-preview {
                font-size: 0.75em;
                max-height: 120px;
            }

            /* Mobile responsive for admin panel layout */
            #adminPanel .data-preview {
                font-size: 0.75em;
                padding: 6px 10px;
                max-height: 60px;
            }

            #adminPanel #previewContent {
                font-size: 0.7em;
            }
        }

        /* Small Mobile (iPhone SE, etc.) */
        @media screen and (max-width: 480px) {
            .header {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .header img {
                height: 28px !important;
            }

            .modal-header img {
                height: 18px !important;
            }

            .main-content {
                padding: 12px;
            }

            .chat-container {
                padding: 12px;
                max-height: 350px;
            }

            .message {
                font-size: 0.8em;
                padding: 8px 12px;
            }

            .user-message {
                max-width: 75%;
                width: fit-content;
                min-width: 40px;
            }

            .ai-message {
                max-width: 95%;
                width: fit-content;
                min-width: 40px;
            }

            .input-group input {
                padding: 10px 12px;
                height: 40px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 0.85em;
                height: 40px;
                min-width: 70px;
            }

            .modal-content {
                width: 98%;
                margin: 5% auto;
            }

            .modal-header {
                padding: 12px;
            }

            .modal-body {
                padding: 12px;
            }

            .form-group textarea {
                height: 72px;
            }

            .modal-footer {
                padding: 12px;
            }

            #adminPanel .data-preview {
                font-size: 0.7em;
                padding: 5px 8px;
                max-height: 50px;
            }

            #adminPanel #previewContent {
                font-size: 0.65em;
            }
        }

        /* Landscape Mobile */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .chat-container {
                max-height: 250px;
            }

            .modal-content {
                margin: 2% auto;
                max-height: 95vh;
            }

            .form-group textarea {
                height: 60px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* Apple's recommended touch target size */
            }

            .close {
                font-size: 28px;
                padding: 8px;
            }

            .input-group input {
                min-height: 44px;
            }

            .input-group {
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Password Protection Modal -->
        <div id="passwordModal" class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="assets/Unilever_logo-onlytext.png" alt="Unilever" style="height: 24px; width: auto;">
                        <h3 style="margin: 0;">🔐 DT Internal Masterdata Access</h3>
                    </div>
                </div>
                <div class="modal-body">
                    <p style="text-align: center; margin-bottom: 20px; color: #666;">
                        Hi and thank you for stopping by! This page is specially made for DT Internal team members.<br>
                        Please enter the access code to continue.
                    </p>
                    <div class="form-group">
                        <label for="accessPassword">Access Code:</label>
                        <input type="password" id="accessPassword" placeholder="Enter access code" onkeypress="handlePasswordKeyPress(event)">
                    </div>
                    <button class="btn btn-primary" onclick="checkPassword()" style="width: 100%;">Enter</button>
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.8em; color: #666;">
                        <strong>Need Access?</strong><br>
                        📞 Contact Ugi: +62 852-4228-3643<br>
                        💬 <a href="https://wa.me/+6285242283643" target="_blank" style="color: #0066CB;">WhatsApp</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px;">
                <img src="assets/unilever-blue-transparent-withtextunderlogo.png" alt="Unilever" style="height: 40px; width: auto;">
                <div>
                    <h1 style="margin: 0; font-size: 1.6em;">🤖 DT Internal Masterdata</h1>
                    <p style="margin: 4px 0 0 0; font-size: 0.85em;">AI-powered data management untuk internal team</p>
                </div>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 12px;">
                <button class="btn btn-edit" onclick="openAdminModal()">Edit Master Data</button>
                <button class="btn btn-secondary" onclick="logoutSession()" style="font-size: 0.7em; padding: 6px 12px;">Logout</button>
            </div>
            <div id="sessionInfo" style="font-size: 0.7em; margin-top: 8px; opacity: 0.8;"></div>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <strong>AI Assistant:</strong> Halo! Saya adalah AI Assistant untuk DT Internal Masterdata. Saya siap membantu menjawab pertanyaan Anda tentang data internal, master data, dan informasi yang tersimpan dalam sistem. Silakan tanyakan apa saja!
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Tanyakan tentang data internal..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">Kirim</button>
                </div>
            </div>

        </div>
    </div>

        <!-- Admin Modal -->
        <div id="adminModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="assets/Unilever_logo-onlytext.png" alt="Unilever" style="height: 24px; width: auto;">
                        <h3 style="margin: 0;">⚙️ Admin Panel</h3>
                    </div>
                    <span class="close" onclick="closeAdminModal()">&times;</span>
                </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="adminCode">Unlock Code:</label>
                        <input type="password" id="adminCode" placeholder="Masukkan unlock code" onkeypress="handleUnlockKeyPress(event)">
                    </div>
                    <button class="btn btn-primary" onclick="unlockAdmin()" style="width: 100%;">🔓 Unlock Admin</button>
                </div>

                <div id="adminPanel" class="hidden">
                    <p style="margin: 0 0 12px 0;"><span class="status-indicator status-online"></span>Terhubung sebagai: <strong>ugi</strong> <span style="color: #28a745; font-weight: bold;">(Admin Mode)</span></p>
                    
                    <div class="data-preview" id="dataPreview" style="margin-bottom: 20px; font-size: 0.8em; padding: 8px 12px; max-height: 80px;">
                        <strong>📊 Preview Data:</strong>
                        <div id="previewContent" style="margin-top: 4px; font-size: 0.75em; line-height: 1.3;">Belum ada data tersimpan</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="masterData">📋 DT Internal Master Data:</label>
                        <textarea id="masterData" placeholder="Paste semua data internal di sini (Ctrl+V):&#10;&#10;Contoh format:&#10;=== INFORMASI PERUSAHAAN ===&#10;Nama: PT Unilever Indonesia&#10;Divisi: DT Internal&#10;Lokasi: Jakarta, Bandung, Surabaya...&#10;&#10;=== DATA OPERASIONAL ===&#10;Proses internal: 1. Data collection...&#10;Sistem: SAP, Oracle, Custom tools...&#10;&#10;=== FAQ & PANDUAN INTERNAL ===&#10;Q: Bagaimana cara akses data X?&#10;A: Login ke portal internal...&#10;&#10;=== INFORMASI KONTAK INTERNAL ===&#10;Email: dt.internal@unilever.com&#10;Ext: 1234&#10;Jam kerja: Senin-Jumat 08:00-17:00"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdminModal()">Tutup</button>
                <button class="btn btn-primary" onclick="saveData()" id="saveBtn" style="display: none;">💾 Simpan Data</button>
            </div>
        </div>
    </div>

    <!-- Socket.io removed for production -->
    <script>
        // Access codes (internal use only)
        const ACCESS_PASSWORD = 'dtunilever2025';
        const ADMIN_UNLOCK_CODE = 'ugi354';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

        let isAccessGranted = false;
        let isAdminLoggedIn = false;
        let conversationHistory = [];
        let socket = null;
        let currentMasterData = '';

        // Session management functions
        function saveSession() {
            const sessionData = {
                timestamp: Date.now(),
                accessGranted: true,
                isAdmin: isAdminLoggedIn,
                masterData: currentMasterData
            };
            localStorage.setItem('dt_session', JSON.stringify(sessionData));
        }

        function loadSession() {
            const sessionData = localStorage.getItem('dt_session');
            if (!sessionData) return false;
            
            try {
                const session = JSON.parse(sessionData);
                const now = Date.now();
                const sessionAge = now - session.timestamp;
                
                if (sessionAge < SESSION_DURATION) {
                    // Session masih valid
                    isAccessGranted = true;
                    isAdminLoggedIn = session.isAdmin || false;
                    currentMasterData = session.masterData || '';
                    return true;
                } else {
                    // Session expired
                    localStorage.removeItem('dt_session');
                    isAccessGranted = false;
                    isAdminLoggedIn = false;
                    return false;
                }
            } catch (error) {
                localStorage.removeItem('dt_session');
                isAccessGranted = false;
                isAdminLoggedIn = false;
                return false;
            }
        }

        function clearSession() {
            localStorage.removeItem('dt_session');
            isAccessGranted = false;
            isAdminLoggedIn = false;
            currentMasterData = '';
        }

        function logoutSession() {
            clearSession();
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('accessPassword').value = '';
            alert('👋 Logged out successfully!');
        }

        function updateSessionInfo() {
            const sessionData = localStorage.getItem('dt_session');
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const now = Date.now();
                    const sessionAge = now - session.timestamp;
                    const remainingTime = SESSION_DURATION - sessionAge;
                    
                    if (remainingTime > 0) {
                        const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                        const adminStatus = session.isAdmin ? ' (Admin Mode)' : '';
                        document.getElementById('sessionInfo').textContent = `Session expires in: ${hours}h ${minutes}m${adminStatus}`;
                    } else {
                        document.getElementById('sessionInfo').textContent = 'Session expired';
                    }
                } catch (error) {
                    document.getElementById('sessionInfo').textContent = '';
                }
            } else {
                document.getElementById('sessionInfo').textContent = '';
            }
        }

        function updateAdminStatus() {
            // Update admin button visibility
            const adminButton = document.querySelector('button[onclick="openAdminModal()"]');
            if (isAdminLoggedIn) {
                adminButton.textContent = 'Admin Mode ✓';
                adminButton.style.background = '#28a745';
            } else {
                adminButton.textContent = 'Edit Master Data';
                adminButton.style.background = '#123062';
            }
        }

        function checkSessionExpiry() {
            if (isAccessGranted && !loadSession()) {
                // Session expired, force logout
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                document.getElementById('accessPassword').value = '';
                alert('⏰ Session expired! Please enter access code again.');
            }
        }

        // Password protection functions
        function checkPassword() {
            const password = document.getElementById('accessPassword').value;
            
            if (password === ACCESS_PASSWORD) {
                isAccessGranted = true;
                saveSession();
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('userInput').focus();
            } else {
                // Show detailed error with contact info
                const errorMessage = `❌ Access code salah!\n\nJika Anda memerlukan akses, silakan hubungi:\n📞 Ugi: +62 852-4228-3643\n💬 WhatsApp: wa.me/+6285242283643`;
                alert(errorMessage);
                document.getElementById('accessPassword').value = '';
            }
        }

        function handlePasswordKeyPress(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }

        // Initialize data loading (simple approach)
        function initializeSocket() {
            // Load master data saat page load
            loadMasterData();
        }
        
        // Load master data from API
        function loadMasterData() {
            fetch('/api/master-data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    currentMasterData = data.content || '';
                    document.getElementById('masterData').value = currentMasterData;
                    updateDataPreview();
                    // Save to session
                    saveSession();
                })
                .catch(error => {
                    console.error('Error loading master data:', error);
                    // Fallback to session data if API fails
                    if (currentMasterData) {
                        document.getElementById('masterData').value = currentMasterData;
                        updateDataPreview();
                    } else {
                        currentMasterData = '';
                        updateDataPreview();
                    }
                });
        }

        // Initialize data from localStorage (for admin)
        function initializeData() {
            const savedData = localStorage.getItem('supplyChainData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('masterData').value = data.masterData || '';
                updateDataPreview();
            }
        }

        // Modal functions
        function openAdminModal() {
            // Check session validity first
            if (!loadSession()) {
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                alert('⏰ Session expired! Please enter access code again.');
                return;
            }
            
            document.getElementById('adminModal').style.display = 'block';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('saveBtn').style.display = 'none';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        // Unlock admin panel
        function unlockAdmin() {
            const unlockCode = document.getElementById('adminCode').value;

            if (unlockCode === ADMIN_UNLOCK_CODE) {
                isAdminLoggedIn = true;
                saveSession(); // Save admin status to session
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('saveBtn').style.display = 'inline-block';
                
                // Load master data into admin panel
                if (currentMasterData) {
                    document.getElementById('masterData').value = currentMasterData;
                    updateDataPreview();
                } else {
                    initializeData();
                }
                
                updateAdminStatus();
            } else {
                alert('❌ Unlock code salah!');
            }
        }

        // Handle Enter key for unlock
        function handleUnlockKeyPress(event) {
            if (event.key === 'Enter') {
                unlockAdmin();
            }
        }

        // Lock admin panel
        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminCode').value = '';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('adminModal');
            if (event.target === modal) {
                closeAdminModal();
            }
        }

        // Mobile-specific improvements
        function handleMobileInput() {
            // Prevent zoom on iOS when focusing input
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 768) {
                        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
            });
        }

        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            handleMobileInput();
            
            // Check session on page load
            if (loadSession()) {
                // Session valid, hide password modal
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('userInput').focus();
                
                // Update admin status if logged in as admin
                if (isAdminLoggedIn) {
                    updateAdminStatus();
                    // Load master data into admin panel
                    if (currentMasterData) {
                        document.getElementById('masterData').value = currentMasterData;
                        updateDataPreview();
                    }
                }
            } else {
                // No valid session, show password modal
                document.getElementById('passwordModal').style.display = 'block';
            }
            
            // Check session expiry every 5 minutes
            setInterval(checkSessionExpiry, 5 * 60 * 1000);
            
            // Update session info every minute
            setInterval(updateSessionInfo, 60 * 1000);
            updateSessionInfo(); // Initial update
            
            // Prevent double-tap zoom on buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    button.click();
                });
            });
        });

        // Save data to server (admin only)
        async function saveData() {
            const masterDataContent = document.getElementById('masterData').value;
            
            if (!masterDataContent.trim()) {
                alert('Master data tidak boleh kosong!');
                return;
            }

            try {
                const response = await fetch('/api/master-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: masterDataContent,
                        updatedBy: 'ugi'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update current master data
                    currentMasterData = masterDataContent;
                    
                    // Save to session
                    saveSession();
                    
                    // Save to localStorage as backup
                    const data = {
                        masterData: masterDataContent,
                        lastUpdated: new Date().toLocaleString()
                    };
                    localStorage.setItem('supplyChainData', JSON.stringify(data));
                    
                    updateDataPreview();
                    alert('✅ Master data berhasil disimpan dan disinkronkan ke semua user!');
                } else {
                    alert('❌ Gagal menyimpan data: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('❌ Gagal menyimpan data. Periksa koneksi server.');
            }
        }

        // Update data preview
        function updateDataPreview() {
            let preview = '';
            
            if (currentMasterData) {
                preview += `📋 Master Data: ${currentMasterData.substring(0, 200)}...<br>`;
                preview += `<br><small>Status: ${isAdminLoggedIn ? 'Admin Mode' : 'Visitor Mode'}</small>`;
            } else {
                preview = 'Belum ada data tersimpan';
            }
            
            document.getElementById('previewContent').innerHTML = preview;
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message to AI
        async function sendMessage() {
            // Check session validity first
            if (!loadSession()) {
                isAccessGranted = false;
                document.getElementById('passwordModal').style.display = 'block';
                alert('⏰ Session expired! Please enter access code again.');
                return;
            }
            
            if (!isAccessGranted) {
                alert('❌ Please enter access code first!');
                return;
            }
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            userInput.value = '';

            // Show loading indicator
            const loadingId = addLoadingMessage();

            try {
                // Call backend API for AI chat
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory
                    })
                });

                const data = await response.json();
                
                // Remove loading message
                removeLoadingMessage(loadingId);

                if (data.success) {
                    const aiResponse = data.response;
                    addMessageToChat(aiResponse, 'ai');
                    
                    // Add to conversation history
                    conversationHistory.push(
                        { role: "user", content: message },
                        { role: "assistant", content: aiResponse }
                    );

                    // Keep only last 10 exchanges to manage token usage
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }
                } else {
                    addMessageToChat('Maaf, terjadi kesalahan dalam memproses permintaan Anda. Silakan coba lagi.', 'ai');
                }

            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage(loadingId);
                addMessageToChat('Maaf, terjadi kesalahan koneksi. Pastikan koneksi internet Anda stabil dan coba lagi.', 'ai');
            }
        }

        // Add message to chat container
        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const senderName = sender === 'user' ? 'Anda' : 'AI Assistant';
            messageDiv.innerHTML = `<strong>${senderName}:</strong> ${message}`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add loading message
        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message ai-message';
            loadingDiv.innerHTML = '<strong>AI Assistant:</strong> <span class="loading"></span> Sedang memproses...';
            
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return loadingId;
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeData();
        });
    </script>
</body>
</html>